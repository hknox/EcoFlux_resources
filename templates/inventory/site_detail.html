{% extends "inventory/layout_base.html" %}

<head>
  {% load django_bootstrap5 %}
  {% load crispy_forms_tags static %}

  {% block extra_css %}
  {% endblock %}

</head>

<body>
  {% block page_heading %} - {{action}} Site{% endblock %}

  {% block content %}

  <form id="id_site_form" class = "mt-3 track-unsaved form-class"
        novalidate method="post" data-form-name="Site form">

    {% csrf_token %}
    {% crispy form %}

    <input type="hidden" name="next" value="{{ request.GET.next|default:'' }}">


    <!-- DOIs Section -->
    {% include "inventory/include/accordion_header.html" with section_id="doi" section_title="DOI Records" mt_3=True button_text="Add DOI Records" formset_prefix=doi_formset.prefix %}

    <div id="doiCollapse"
         class="accordion-collapse collapse"
         aria-labelledby="doiHeading">
      <div class="accordion-body">
        {% if not doi_formset.forms %}
        <div class="row mt-2">No DOI records for this site yet.</div>
        {% endif %}
        {% include "inventory/include/formset_block.html" with formset=doi_formset %}
      </div>
    </div>

    {% if action == "Edit" %}

    <!-- Field Notes Section -->
    {% include "inventory/include/accordion_header.html" with section_id="fieldnotes" section_title="Field Notes" button_text="Add a field note" button_url=fieldnote_create_url mt_3=True %}

    <div id="fieldnotesCollapse"
         class="accordion-collapse collapse"
         aria-labelledby="fieldnotesHeading">
      <div class="accordion-body">
        {% if fieldnotes %}
        <table class="table table-striped table-hover table-bordered mt-2">
          <thead>
            <th>Date submitted</th>
            <th>Summary</th>
            <th>Submitted by</th>
          </thead>
          <tbody>
            {% for note in fieldnotes %}
            <tr>
              <td>
                <a href="{% url 'fieldnote_edit' note.pk %}{{success_url}}">
                  {{ note.date_visited }}
                </a>
              </td>
              {% if note.summary %}
              <td>{{ note.summary }}</td>
              {% else %}
              <td>{{ note.note|truncatechars:80 }}</td>
              {% endif %}
              <td>{{ note.submitter }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="mt-2">No field notes for this site yet.</div>
        {% endif %}
      </div>
    </div>

    <!-- Equipment Section -->
    {% include "inventory/include/accordion_header.html" with section_id="equipment" section_title="Equipment" button_text="Add new equipment" button_url=equipment_create_url mt_3=True %}

    <div id="equipmentCollapse"
         class="accordion-collapse collapse"
         aria-labelledby="equipmentHeading">
      <div class="accordion-body">
        {% if equipment %}
        <table class="table table-striped table-hover table-bordered mt-2">
          <thead>
            <th>Instrument</th>
            <th>Notes</th>
          </thead>
          <tbody>
            {% for item in equipment %}
            <tr>
              <td>
                <a href="{% url 'equipment_edit' item.pk %}{{success_url}}" class="">
                  {{ item.instrument }}
                </a>
              </td>
              <td>{{ item.notes|truncatechars:80 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="mt-2">No equipment at this site yet.</div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {% include "inventory/include/messages.html" %}

    <!-- Save/Cancel/Delete buttons -->
    {% include "inventory/include/save_cancel_delete.html" %}

  </form>

  {% endblock content %}

  {% block extra_js %}

  {% include "inventory/include/flatpickr.html" %}
  {# NB important: formset_add.js must load AFTER form_protect.js #}
  <script src="{% static 'js/formset_add.js' %}"></script>
  <script src="{% static 'js/delete_button.js' %}"></script>
  {% endblock extra_js %}
</body>
