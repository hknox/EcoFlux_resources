{% extends "inventory/layout_base.html" %}

<head>
  {% load django_bootstrap5 %}
  {% load crispy_forms_tags static %}

  {% block extra_css %}
  {% endblock %}

</head>

<body>
  {% block page_heading %} - {{action}} Site{% endblock %}

  {% block content %}

  <form id="id_site_form" class = "mt-3 track-unsaved form-class" novalidate method="post">

    {% csrf_token %}
    {% crispy form %}

    <!-- DOI formset -->
    <div class="d-flex justify-content-between align-items-center mt-2 mb-0 bg-primary">
      <h5 class="mb-0 mt-0 me-1 ms-2 text-bg-primary">DOI records</h5> -->
      <button type="button"
              class="btn btn-info btn-sm add-form-row"
              data-formset-prefix="{{ doi_formset.prefix }}">
        <i class="bi bi-plus-circle"></i> Add a DOI record
      </button>
    </div>
    {% if not doi_formset.forms %}
      <div type="row" class="mt-2">No DOI records for this site yet.</div>
    {% endif %}
    {% include "inventory/include/formset_block.html" with formset=doi_formset %}

    <!-- These are only shown if we are editing an existing site -->
    {% if action == "Edit" %}
      <!-- FieldNotes -->
      <div class="d-flex justify-content-between align-items-center mt-2 mb-0 bg-primary">
        <h5 class="mb-0 mt-0 me-1 ms-2 text-bg-primary">Field notes</h5>
        <a href="{% url 'fieldnote_create' %}?next={{request.get_full_path}}&site={{ site.id }}"
           class="btn btn-info btn-sm">
          <i class="bi bi-plus-circle"></i> Add a field note</a>
      </div>
      {% if fieldnotes %}
        <table class="table table-striped table-hover table-bordered mt-2">
          <thead>
            <th>Date submitted</th>
            <th>Summary</th>
            <th>Submitted by</th>
          </thead>
          <tbody>
            {% for note in fieldnotes %}
              <tr>
                <td>
                  <a href="{% url 'fieldnote_edit' note.pk %}?next={{request.get_full_path}}">
                    {{ note.date_submitted }}
                  </a>
                </td>
                {% if note.summary %}
                  <td>{{ note.summary }}</td>
                {% else %}
                  <td>{{ note.note|truncatechars:80 }}</td>
                {% endif %}
                <td>{{ note.submitter }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div type="row" class="mt-2">No field notes for this site yet.</div>
      {% endif %}
      <!-- Equipment -->
      <div class="d-flex justify-content-between align-items-center mt-2 mb-0 bg-primary">
        <h5 class="mb-0 mt-0 me-1 ms-2 text-bg-primary">Equipment</h5>
        <a href="{% url 'equipment_add' %}" class="ajax-modal-link btn btn-info btn-sm">
          <i class="bi bi-plus-circle"></i> Add an item</a>
      </div>
      {% if equipment %}
        <table class="table table-striped table-hover table-bordered mt-2">
          <thead>
            <th>Instrument</th>
            <th>Notes</th>
          </thead>
          <tbody>
            {% for item in equipment %}
              <tr>
                <td>
                  <a href="{% url 'equipment_edit' item.pk %}" class="ajax-modal-link">
                  {{ item.instrument }}
                  </a>
                </td>
                <td>{{ item.notes|truncatechars:80 }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div type="row" class="mt-2">No equipment for this site yet.</div>
      {% endif %}
    {% endif %}

    <!-- Save/Cancel/Delete buttons -->
    {% include "inventory/save_cancel_delete.html" %}

  </form>

  <!-- Modal for related class creation/editing -->
  <div class="modal fade" id="ajaxModal" tabindex="-1" aria-labelledby="ajaxModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ajaxModalLabel">Loading...</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Form will load here -->
        </div>
      </div>
    </div>
  </div>

  {% endblock content %}

  {% block extra_js %}

  {% include "inventory/include/flatpickr.html" %}
  {# NB important: formset_add.js must load AFTER form_protect.js #}
  <script src="{% static 'js/formset_add.js' %}"></script>
  <script src="{% static 'js/delete_button.js' %}"></script>
  <script src="{% static 'js/modal_record_add.js' %}"></script>
  {% endblock extra_js %}
</body>
