{% extends "inventory/layout_base.html" %}

<head>
  {% load django_bootstrap5 %}
  {% load crispy_forms_tags static %}

  {% block extra_css %}
  {% endblock %}

</head>

<body>
  {% block page_heading %}EcoFlux - {{action}}Site{% endblock %}

  {% block content %}
  <!-- <h2>{{action}} Site</h2> -->

   <!-- Re: 'novalidate' attribute:
       See https://docs.djangoproject.com/en/5.2/topics/forms/:

       "If your form includes a URLField, an EmailField or any
       integer field type, Django will use the url, email and number
       HTML5 input types. By default, browsers may apply their own
       validation on these fields, which may be stricter than
       Djangoâ€™s validation. If you would like to disable this
       behavior, set the novalidate attribute on the form tag, or
       specify a different widget on the field, like TextInput."
       Without it the saved-data check fails to run -->


  <form id="id_site_form" class = "mt-3 track-unsaved form-class" novalidate method="post">

    {% csrf_token %}
    {% crispy form %}

    <!-- DOI formset -->
    <div class="d-flex justify-content-between align-items-center mt-2 mb-0 bg-primary">
      <h5 class="mb-0 mt-0 me-1 ms-2 text-bg-primary">DOI records</h5> -->
      <button type="button"
              class="btn btn-info btn-sm add-form-row"
              data-formset-prefix="{{ doi_formset.prefix }}">
        <i class="bi bi-plus-circle"></i> Add a DOI record
      </button>
    </div>
    {% include "inventory/include/formset_block.html" with formset=doi_formset %}

    <!-- FieldNotes -->
    <!-- These are only shown if we are editing an existing, deletable site -->
    {% if delete_url %}
      <div class="d-flex justify-content-between align-items-center mt-2 mb-0 bg-primary">
        <h5 class="mb-0 mt-0 me-1 ms-2 text-bg-primary">Field notes</h5>
        <a href="{% url 'fieldnote_create' %}?next={{request.get_full_path}}&site={{ site.id }}"
           class="btn btn-info btn-sm">
          <i class="bi bi-plus-circle"></i> Add a field note</a>
      </div>
      {% if fieldnotes %}
        <table class="table table-striped table-hover table-bordered mt-2">
          <thead>
            <th>Date submitted</th>
            <th>Summary</th>
            <th>Submitted by</th>
          </thead>

          <tbody>
            {% for note in fieldnotes %}
              <tr>
                <td>{{ note.date_submitted }}</td>
                {% if note.summary %}
                  <td>{{ note.summary }}</td>
                {% else %}
                  <td>{{ note.note|truncatechars:80 }}</td>
                {% endif %}
                <td>{{ note.submitter }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <h5 class="mt-2 ms-2">No field notes for this site yet.</h5>
      {% endif %}


    {% endif %}

    <!-- Save/Cancel/Delete buttons -->
    {% include "inventory/save_cancel_delete.html" %}

  </form>

  {% endblock content %}

  {% block extra_js %}

  {% include "inventory/include/flatpickr.html" %}
  {# NB important: formset_add.js must load AFTER form_protect.js #}
  <script src="{% static 'js/formset_add.js' %}"></script>
  <script src="{% static 'js/delete_button.js' %}"></script>

  {% endblock extra_js %}
</body>
